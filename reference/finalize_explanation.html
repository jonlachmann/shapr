<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Computes the Shapley values given v(S) — finalize_explanation • shapr</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Computes the Shapley values given v(S) — finalize_explanation"><meta property="og:description" content="Computes dependence-aware Shapley values for observations in x_explain from the specified
model by using the method specified in approach to estimate the conditional expectation."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.3.9200</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/understanding_shapr.html">General usage of shapr</a>
    </li>
    <li>
      <a href="../articles/understanding_shapr_vaeac.html">Advanced usage of the `vaeac` approach</a>
    </li>
    <li>
      <a href="../articles/understanding_shapr_regression.html">The separate and surrogate regression approches</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/NorskRegnesentral/shapr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Computes the Shapley values given <code>v(S)</code></h1>
    <small class="dont-index">Source: <a href="https://github.com/NorskRegnesentral/shapr/blob/master/R/finalize_explanation.R" class="external-link"><code>R/finalize_explanation.R</code></a></small>
    <div class="hidden name"><code>finalize_explanation.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Computes dependence-aware Shapley values for observations in <code>x_explain</code> from the specified
<code>model</code> by using the method specified in <code>approach</code> to estimate the conditional expectation.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">finalize_explanation</span><span class="op">(</span><span class="va">vS_list</span>, <span class="va">internal</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-vs-list">vS_list<a class="anchor" aria-label="anchor" href="#arg-vs-list"></a></dt>
<dd><p>List
Output from <code><a href="compute_vS.html">compute_vS()</a></code></p></dd>


<dt id="arg-internal">internal<a class="anchor" aria-label="anchor" href="#arg-internal"></a></dt>
<dd><p>List.
Holds all parameters, data, functions and computed objects used within <code><a href="explain.html">explain()</a></code>
The list contains one or more of the elements <code>parameters</code>, <code>data</code>, <code>objects</code>, <code>output</code>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>Object of class <code>c("shapr", "list")</code>. Contains the following items:</p><dl><dt>shapley_values</dt>
<dd><p>data.table with the estimated Shapley values</p></dd>

<dt>internal</dt>
<dd><p>List with the different parameters, data and functions used internally</p></dd>

<dt>pred_explain</dt>
<dd><p>Numeric vector with the predictions for the explained observations</p></dd>

<dt>MSEv</dt>
<dd><p>List with the values of the MSEv evaluation criterion for the approach.</p></dd>


</dl><p><code>shapley_values</code> is a data.table where the number of rows equals
the number of observations you'd like to explain, and the number of columns equals <code>m +1</code>,
where <code>m</code> equals the total number of features in your model.</p>
<p>If <code>shapley_values[i, j + 1] &gt; 0</code> it indicates that the j-th feature increased the prediction for
the i-th observation. Likewise, if <code>shapley_values[i, j + 1] &lt; 0</code> it indicates that the j-th feature
decreased the prediction for the i-th observation.
The magnitude of the value is also important to notice. E.g. if <code>shapley_values[i, k + 1]</code> and
<code>shapley_values[i, j + 1]</code> are greater than <code>0</code>, where <code>j != k</code>, and
<code>shapley_values[i, k + 1]</code> &gt; <code>shapley_values[i, j + 1]</code> this indicates that feature
<code>j</code> and <code>k</code> both increased the value of the prediction, but that the effect of the k-th
feature was larger than the j-th feature.</p>
<p>The first column in <code>dt</code>, called <code>none</code>, is the prediction value not assigned to any of the features
(\(\phi\)<sub>0</sub>).
It's equal for all observations and set by the user through the argument <code>prediction_zero</code>.
The difference between the prediction and <code>none</code> is distributed among the other features.
In theory this value should be the expected prediction without conditioning on any features.
Typically we set this value equal to the mean of the response variable in our training data, but other choices
such as the mean of the predictions in the training data are also reasonable.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>The most important thing to notice is that <code>shapr</code> has implemented eight different
Monte Carlo-based approaches for estimating the conditional distributions of the data, namely <code>"empirical"</code>,
<code>"gaussian"</code>, <code>"copula"</code>, <code>"ctree"</code>, <code>"vaeac"</code>, <code>"categorical"</code>, <code>"timeseries"</code>, and <code>"independence"</code>.
<code>shapr</code> has also implemented two regression-based approaches <code>"regression_separate"</code> and <code>"regression_surrogate"</code>,
and see the separate vignette on the regression-based approaches for more information.
In addition, the user also has the option of combining the different Monte Carlo-based approaches.
E.g., if you're in a situation where you have trained a model that consists of 10 features,
and you'd like to use the <code>"gaussian"</code> approach when you condition on a single feature,
the <code>"empirical"</code> approach if you condition on 2-5 features, and <code>"copula"</code> version
if you condition on more than 5 features this can be done by simply passing
<code>approach = c("gaussian", rep("empirical", 4), rep("copula", 4))</code>. If
<code>"approach[i]" = "gaussian"</code> means that you'd like to use the <code>"gaussian"</code> approach
when conditioning on <code>i</code> features. Conditioning on all features needs no approach as that is given
by the complete prediction itself, and should thus not be part of the vector.</p>
<p>For <code>approach="ctree"</code>, <code>n_samples</code> corresponds to the number of samples
from the leaf node (see an exception related to the <code>sample</code> argument).
For <code>approach="empirical"</code>, <code>n_samples</code> is  the \(K\) parameter in equations (14-15) of
Aas et al. (2021), i.e. the maximum number of observations (with largest weights) that is used, see also the
<code>empirical.eta</code> argument.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Aas, K., Jullum, M., &amp; L&lt;U+00F8&gt;land, A. (2021). Explaining individual predictions when features are dependent:
More accurate approximations to Shapley values. Artificial Intelligence, 298, 103502.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Martin Jullum, Lars Henry Berge Olsen</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load example data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"airquality"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">airquality</span> <span class="op">&lt;-</span> <span class="va">airquality</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html" class="external-link">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">x_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Solar.R"</span>, <span class="st">"Wind"</span>, <span class="st">"Temp"</span>, <span class="st">"Month"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">y_var</span> <span class="op">&lt;-</span> <span class="st">"Ozone"</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Split data into test- and training data</span></span></span>
<span class="r-in"><span><span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data_explain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">data_train</span><span class="op">[</span>, <span class="va">x_var</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">x_explain</span> <span class="op">&lt;-</span> <span class="va">data_explain</span><span class="op">[</span>, <span class="va">x_var</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Fit a linear model</span></span></span>
<span class="r-in"><span><span class="va">lm_formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">y_var</span>, <span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x_var</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">lm_formula</span>, data <span class="op">=</span> <span class="va">data_train</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Explain predictions</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data_train</span><span class="op">[</span>, <span class="va">y_var</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Empirical approach</span></span></span>
<span class="r-in"><span><span class="va">explain1</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"empirical"</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  n_samples <span class="op">=</span> <span class="fl">1e2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 2 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Gaussian approach</span></span></span>
<span class="r-in"><span><span class="va">explain2</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"gaussian"</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  n_samples <span class="op">=</span> <span class="fl">1e2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 10 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Gaussian copula approach</span></span></span>
<span class="r-in"><span><span class="va">explain3</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"copula"</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  n_samples <span class="op">=</span> <span class="fl">1e2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 10 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ctree approach</span></span></span>
<span class="r-in"><span><span class="va">explain4</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"ctree"</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  n_samples <span class="op">=</span> <span class="fl">1e2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 10 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Combined approach</span></span></span>
<span class="r-in"><span><span class="va">approach</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gaussian"</span>, <span class="st">"gaussian"</span>, <span class="st">"empirical"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">explain5</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="va">approach</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  n_samples <span class="op">=</span> <span class="fl">1e2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 10 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Print the Shapley values</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">explain1</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        none   Solar.R       Wind       Temp     Month</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       &lt;num&gt;     &lt;num&gt;      &lt;num&gt;      &lt;num&gt;     &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: 42.78704  6.124296 -20.137653  -5.033967 -5.987303</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: 42.78704 -1.470838  11.525868  -9.487924 -5.597657</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3: 42.78704  3.524599  -5.335059 -16.599988 -8.703929</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot the results</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">explain1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">explain1</span>, plot_type <span class="op">=</span> <span class="st">"waterfall"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-plt img"><img src="finalize_explanation-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Group-wise explanations</span></span></span>
<span class="r-in"><span><span class="va">group_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Temp"</span>, <span class="st">"Month"</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Wind"</span>, <span class="st">"Solar.R"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">explain_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  group <span class="op">=</span> <span class="va">group_list</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"empirical"</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  n_samples <span class="op">=</span> <span class="fl">1e2</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 2 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">explain_groups</span><span class="op">$</span><span class="va">shapley_values</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        none         A          B</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       &lt;num&gt;     &lt;num&gt;      &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: 42.78704 -11.63856 -13.396062</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: 42.78704 -10.36824   5.337683</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3: 42.78704 -25.79874  -1.315633</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Separate and surrogate regression approaches with linear regression models.</span></span></span>
<span class="r-in"><span><span class="co"># More complex regression models can be used, and we can use CV to</span></span></span>
<span class="r-in"><span><span class="co"># tune the hyperparameters of the regression models and preprocess</span></span></span>
<span class="r-in"><span><span class="co"># the data before sending it to the model. See the regression vignette</span></span></span>
<span class="r-in"><span><span class="co"># (Shapley value explanations using the regression paradigm) for more</span></span></span>
<span class="r-in"><span><span class="co"># details about the `regression_separate` and `regression_surrogate` approaches.</span></span></span>
<span class="r-in"><span><span class="va">explain_separate_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"regression_separate"</span>,</span></span>
<span class="r-in"><span>  regression.model <span class="op">=</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 2 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">explain_surrogate_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="explain.html">explain</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  model <span class="op">=</span> <span class="va">model</span>,</span></span>
<span class="r-in"><span>  x_explain <span class="op">=</span> <span class="va">x_explain</span>,</span></span>
<span class="r-in"><span>  x_train <span class="op">=</span> <span class="va">x_train</span>,</span></span>
<span class="r-in"><span>  prediction_zero <span class="op">=</span> <span class="va">p</span>,</span></span>
<span class="r-in"><span>  approach <span class="op">=</span> <span class="st">"regression_surrogate"</span>,</span></span>
<span class="r-in"><span>  regression.model <span class="op">=</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Setting parameter 'n_batches' to 2 as a fair trade-off between memory consumption and computation time.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Reducing 'n_batches' typically reduces the computation time at the cost of increased memory consumption.</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Nikolai Sellereite, Martin Jullum, Lars Henry Berge Olsen, Annabelle Redelmeier, Jon Lachmann, Norsk Regnesentral.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>






  </body></html>

